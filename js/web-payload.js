function modify(id, content){
	$(`#${id}`).val(content);
}

function append(id, content){
	$(`#${id}`).append(content);
}

function sendGetRequest(url_){
	chrome.tabs.update({url: url_});
}

//TODO:
function sendPostRequest(url_, post_json){
    // console.log(message);
    alert(post_json);
    chrome.tabs.onUpdated.addListener( function(tabId, changeInfo, tab) {
    	if(changeInfo.status == "loading"){
        var request = new XMLHttpRequest();
        request.open("POST", url_, true);
        request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        request.send(post_json);
    	}
	});
}

function htmlEncode(value){
	// 建立一個暫存的div元素，並使用text()將內容存成html編碼文字後再用html()取出
	return $('<div/>').text(value).html();
}

function removePostData(id){
	$(`#${id}`).remove(content);
}

function jsReadFiles(files) {
  $.get(files,{},function(content){
	    let lines=content.split('\n');
	    var payload_lines = "";
	    for(var idx = 0; idx < `${lines.length}`; idx++)
	    {
	    	payload_lines += "<option class=\"payloads\">" + htmlEncode(lines[idx]) + "</option>"
	    }
	    $('#choose_payload').attr("size",`${lines.length}`);
	    $('#choose_payload').append(payload_lines);
	});
 }

$(document).ready(function() {

    chrome.tabs.getSelected(null,function(tab) {
	    var tablink = decodeURI(tab.url);

	    $("#load_url").click(function(){
			modify("url_text_box", tablink);
		});
	});

    //get button
	$("#send_get").click(function(){
		sendGetRequest($("#url_text_box").val())
	});

	//post button
	var post_json = {};

	$("#send_post").click(function(){
		$('#post-data-content > tr').each(function() {
			var key = $(this).find('input').eq(0).val();
			var value = $(this).find('input').eq(1).val();
			post_json[key] = value;
			// var cell_of_post = $(this).find(".cell-of-post").html();
		});
		sendPostRequest($("#url_text_box").val(), post_json)
	});

	$("#plus_post_data").click(function(){
		var label_list = '<tr>\
							<td style="width:15px"><button class="postdatalist" style="left:-5px;">❌</button></td> \
							</td>\
							<td>\
								<div class="ui input">\
									<input type="text" style="width:250px" class="cell-of-post" placeholder="key" value="">\
								</div>\
							</td>\
							<td>\
								<div class="ui input">\
									<input type="text" style="width:250px" class="cell-of-post" placeholder="value" value="">\
								</div>\
							</td>\
						</tr>'
		$("#post-data-content").append(label_list);

		$(".postdatalist").off();
		$(".postdatalist").click(function () {
			$(this).parent().parent().remove();
		});
	});

	$("#payload_list").change(function(){
		var list_selected = $("#payload_list").val();
		$("#choose_payload").empty();
		var option_list = ["cmd_inj-basic", "cmd_inj-bypass", "xss-basic", "xss-bypass", "php-lfi", "sqli", "ssti", "web_shell_payload"];
		for(var i = 0; i < option_list.length; i++)
		{
			if(list_selected == option_list[i])
			{
				if(list_selected == "cmd_inj-basic")
				{
					jsReadFiles("./assets/cmd_inj/basic.txt");
				}
				else if(list_selected == "cmd_inj-bypass")
				{
					jsReadFiles("./assets/cmd_inj/bypass.txt");
				}
				else if(list_selected == "xss-basic")
				{
					jsReadFiles("./assets/xss/basic.txt");
				}
				else if(list_selected == "xss-bypass")
				{
					jsReadFiles("./assets/xss/bypass.txt");
				}
				else
				{
					jsReadFiles("./assets/" + option_list[i] + ".txt");
				}
			}
			else
			{
				$("#choose_payload").val("");
			}
		}

	});


	$('#choose_payload').on('dblclick', 'option', function() {
    	$('#payload_copy_box').val($(this).val())
	});

	$('.menu .item').tab();

});



