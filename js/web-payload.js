function modify(id, content){
	$(`#${id}`).val(content);
}

function append(id, content){
	$(`#${id}`).append(content);
}

function modify_spilt(id, content){
	content = content.replace(new RegExp(/&/g), "\n&");
	content = content.replace(new RegExp(/\?/g), "\n?");
	$(`#${id}`).val(content);
}

function sendGetRequest(url){
	chrome.tabs.update({url: url});
}

function sendPostRequest(data){
	chrome.tabs.create({"url": data});
}

function htmlEncode(value){
	return $('<div/>').text(value).html();
}

function removePostData(id){
	$(`#${id}`).remove(content);
}

function jsReadFiles(files) {
  $.get(files,{},function(content){
	    let lines=content.split('\n');
	    var payload_lines = "";
	    for(var idx = 0; idx < `${lines.length}`; idx++)
	    {
	    	payload_lines += "<option class=\"payloads\">" + htmlEncode(lines[idx]) + "</option>"
	    }
	    $('#choose_payload').attr("size",`${lines.length}`);
	    $('#choose_payload').append(payload_lines);
	});
 }

 function fakePost(url, data) {
    var form = document.createElement("form");
    form.setAttribute("method", "post");
    form.setAttribute("action", url);

    for(var key in data) {
        var hiddenField = document.createElement("input");
        hiddenField.setAttribute("type", "hidden");
        hiddenField.setAttribute("name", key);
        hiddenField.setAttribute("value", data[key]);
        form.appendChild(hiddenField);
    }
    document.body.appendChild(form);
    form.submit();
};

$(document).ready(function() {

    chrome.tabs.getSelected(null,function(tab) {
	    var tablink = decodeURI(tab.url);

	    $("#load_get_url").click(function(){
			modify("get_url_text_box", tablink);
		});

		$("#load_post_url").click(function(){
			modify("post_url_text_box", tablink);
		});

		$("#get_split_url").click(function(){
			modify_spilt("get_url_text_box", tablink);
		});

		$("#post_split_url").click(function(){
			modify_spilt("post_url_text_box", tablink);
		});

	});

    //Get
	$("#send_get").click(function(){
		sendGetRequest($("#get_url_text_box").val())
	});


	//Post
	$("#send_post").click(function(){

		var data = {};
		$('#post-data-content > tr').each(function() {
			var key = $(this).find('input').eq(0).val();
			var value = $(this).find('input').eq(1).val();
			data[key] = value;
		});
		var url = $("#post_url_text_box").val();

		var fakePostCode = fakePost.toString().replace(/(\n|\t)/gm,'');

		var post_data = "javascript:"+fakePostCode+";"+ "fakePost(\"" + url + "\"," +JSON.stringify(data) + ");";
		sendPostRequest(post_data);
	});

	$("#plus_post_data").click(function(){
		var label_list = '<tr>\
							<td style="width:15px"><button class="postdatalist" style="left:-5px;">‚ùå</button></td> \
							</td>\
							<td>\
								<div class="ui input">\
									<input type="text" style="width:250px" class="cell-of-post" placeholder="key" value="">\
								</div>\
							</td>\
							<td>\
								<div class="ui input">\
									<input type="text" style="width:250px" class="cell-of-post" placeholder="value" value="">\
								</div>\
							</td>\
						</tr>'
		$("#post-data-content").append(label_list);

		$(".postdatalist").off();
		$(".postdatalist").click(function () {
			$(this).parent().parent().remove();
		});
	});




	//web payload
	$("#payload_list").change(function(){
		var list_selected = $("#payload_list").val();
		$("#choose_payload").empty();
		var option_list = ["cmd_inj-basic", "cmd_inj-bypass", "xss-basic", "xss-bypass", "php-lfi", "sqli", "ssti", "web_shell_payload"];
		for(var i = 0; i < option_list.length; i++)
		{
			if(list_selected == option_list[i])
			{
				if(list_selected == "cmd_inj-basic")
				{
					jsReadFiles("./assets/cmd_inj/basic.txt");
				}
				else if(list_selected == "cmd_inj-bypass")
				{
					jsReadFiles("./assets/cmd_inj/bypass.txt");
				}
				else if(list_selected == "xss-basic")
				{
					jsReadFiles("./assets/xss/basic.txt");
				}
				else if(list_selected == "xss-bypass")
				{
					jsReadFiles("./assets/xss/bypass.txt");
				}
				else
				{
					jsReadFiles("./assets/" + option_list[i] + ".txt");
				}
			}
			else
			{
				$("#choose_payload").val("");
			}
		}

	});


	$('#choose_payload').on('dblclick', 'option', function() {
    	$('#payload_copy_box').val($(this).val())
	});

	$('.menu .item').tab();

});