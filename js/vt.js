//testing

//Vt_api = "2a22f025a48a058cb9b5f416273355fdc26f3406d234cb7c36929c818737035b"
Vt_api = ""
HOST = ""
Vt = {}
Vt.HOST = "https://www.virustotal.com/vtapi/v2/domain/report?apikey="
Vt.DOMAIN = "&domain="
HOSTNAME = ""

function Vt_get_data() {
	$.ajax({
		type: "get",
		url: Vt.HOST + Vt_api + Vt.DOMAIN + HOSTNAME,
		success: function (res) {
			console.log(res);
			subdomain_list = [];
			if (res.subdomains) {
				subdomain_list = res.subdomains;
			} else if (res.domain_siblings && res.domain_siblings.length != 0) {
				subdomain_list = res.domain_siblings;
			}

			if (subdomain_list && subdomain_list.length != 0) {
				for (var i = 0; i < subdomain_list.length; i++) {
					vul = subdomain_list[i];
					Vt_list_subdomain(vul);
				}
			} else {
				Vt_list_subdomain("No subdomain Found");
			}
			$(".subdomain_item").off();
			$(".subdomain_item").click(function () {
				host = $(this).text();
				Shodan_updateNewdomain(host);
			})

			resolutions = [];
			if (res.resolutions) {
				resolutions = res.resolutions;
			}
			if (resolutions && resolutions.length != 0) {
				Vt_form_resolutinos(resolutions);
			} else {
				console.log("No resolutions");
			}
		}
	})
}


function Vt_form_resolutinos(data) {
	item = document.getElementById("vt_resolutions")
	for (var i = 0; i < data.length; i++) {
		vul = data[i];
		date = vul.last_resolved
		ip  = vul.ip_address;
		Vt_list_resolutions(date, ip)

	}
}


function Vt_list_subdomain(url) {
	html = Vt_subdomains_html(url);
	$("#vt_subdomain").append(html);
}


function Vt_subdomains_html(url) {
	return '\
	<div class="item subdomain_item">' +
		url + '<\div>';
}

function Vt_list_resolutions(date, ip) {
	html = Vt_resolutions_html(date, ip);
	$("#vt_resolutions").append(html);
}


function Vt_resolutions_html(date, ip) {
	return '\
    <div class="column">\
        <div class="title">' + ip +
		'</div>\
    <div class="content">' + date + '</div>\
  </div>';

}


function VT_exec() {
	Vt_get_data();
}

function VT_rerun(newhost) {
	HOSTNAME = newhost
	VT_exec()
}

$(document).ready(function () {
	HOSTNAME = NOW_URL.hostname
	chrome.storage.sync.get(["vt_key"], function(result) {
        if(Object.keys(result).length) {
		   Vt_api = result.vt_key;
		   VT_exec();
        }
        else {
            alert("No VirusTotal API Key");
        }
    });
	

})